<!DOCTYPE html>
<!-- twitter search api + bing speak api -->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta charset="utf-8" />

<title>tweet-speak</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script>
<script src="https://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>

<style>
td, th {
  vertical-align: top;
}

.avatar img {
  width: 48px;
  height: 48px;
}
</style>

<script>

// XXX: Change this variable to your appid.
// See http://www.bing.com/developers/
var bing_appid = '7E4F352C80692687D39E6CD42998104C5F79281C';

var speak_default_language = 'en';
var speak_languages = ['en'];

// When using jsonp $.ajax() doesn't call error handler for server error.
// Use timeout to handle request error.
var jsonp_timeout = 3 * 60 * 1000;

var rowdelay = 3000;
var requestdelay = 15000;

var currentsearch = null;

function selfy(self, methods) {
  var method;
  for (method in methods) {
    if (methods.hasOwnProperty(method)) {
      self[method] = methods[method].bind(self, self);
    }
  }
  return self;
}

function timeout(msec) {
  var d = $.Deferred();
  var t = setTimeout(function() { d.resolve(); }, msec);
  var p = d.promise();
  p.clear = function() { clearTimeout(t); };
  return p;
}

function search(q, lang, since_id) {
  var url = 'https://search.twitter.com/search.json';
  var data = {
    q: q,
    lang: lang,
    result_type: 'recent'
  };
  if (since_id) {
    data.since_id = since_id;
  }
  return $.ajax({
    url: url,
    data: data,
    dataType: 'jsonp',
    jsonp: 'callback',
    timeout: jsonp_timeout
  });
}

function speak(text, lang) {
  var d = $.Deferred();
  var url = 'https://api.microsofttranslator.com/V2/Ajax.svc/Speak';
  var data = {
    appId: bing_appid,
    text: text,
    language: lang
  };
  $.ajax({
    url: url,
    data: data,
    dataType: 'jsonp',
    jsonp: 'oncomplete',
    timeout: jsonp_timeout
  }).then(function(streamurl) {
    var t = timeout(jsonp_timeout);
    t.done(function() { d.reject(); });
    if ($.browser.msie) {
      var iesound = $('#iesound').get(0);
      iesound.onended = function() { t.clear(); d.resolve(); };
      iesound.FileName = streamurl;
    } else {
      $('#speakaudio')
        .attr('src', streamurl)
        .bind('ended', function() { t.clear(); d.resolve(); })
        .get(0).play();
    }
  }, function(xhr, textStatus, errorThrown) {
    console.log(textStatus, errorThrown);
    d.reject();
  });
  return d.promise();
}

function detect(text) {
  var url = 'https://api.microsofttranslator.com/V2/Ajax.svc/Detect';
  var data = {
    appId: bing_appid,
    text: text
  };
  return $.ajax({
      url: url,
      data: data,
      dataType: 'jsonp',
      jsonp: 'oncomplete',
      timeout: jsonp_timeout
    });
}

function getLanguagesForSpeak() {
  var url = 'http://api.microsofttranslator.com/V2/Ajax.svc/GetLanguagesForSpeak';
  var data = {
    appId: bing_appid
  };
  return $.ajax({
      url: url,
      data: data,
      dataType: 'jsonp',
      jsonp: 'oncomplete',
      timeout: jsonp_timeout
    });
}

// TODO:
function textfilter(text, lang) {
  var s = text;
  // decode html entity
  s = $('<div><\/div>').html(s).text();
  s = s.replace(/[a-z]+:\/\/[\x00-\x08\x0A-\x1F\x21-\x7F]+/g, '');
  // WORKAROUND: bing ajax api returns error for text=%22
  // "There was an error deserializing the object of type System.String. Unexpected end of file. Following elements are not closed: root."
  s = s.replace(/"/g, ' ');
  return s;
}

function htmlfilter(text) {
  var s = text;
  s = s.replace(/[a-z]+:\/\/[\x00-\x08\x0A-\x1F\x21-\x7F]+/g, '<a href="$&">$&<\/a>');
  return s;
}

var SearchContext = function(q, lang) {
  var self = selfy(this, SearchContext.prototype);
  self.q = q;
  self.lang = lang;
  self.since_id = null;
  self.i = 0;
  self.results = null;
  self.d = null;
};

SearchContext.prototype.next = function(self) {
  self.d = $.Deferred();
  if (self !== currentsearch) {
    return self.d.promise();
  }
  if (self.results && self.i < self.results.length) {
    self.d.resolve(self.results[self.i++]);
  } else {
    self.search();
  }
  return self.d.promise();
};

SearchContext.prototype.search = function(self) {
  search(self.q, self.lang, self.since_id).then(
    self.on_search_done,
    self.on_search_fail);
};

SearchContext.prototype.on_search_done = function(self, data) {
  // MEMO: data.refresh_url doesn't contain lang param
  if (self !== currentsearch) {
    return;
  }
  if (data.error) {
    $('#status').text('twitter search error: ' + data.error);
    self.d.reject();
    return;
  }
  if (data.results.length === 0) {
    $('#status').text('waiting');
    timeout(requestdelay).done(self.search);
    return;
  }
  $('#status').text('');
  self.since_id = data.max_id_str;
  self.i = 0;
  self.results = data.results.reverse();
  self.d.resolve(self.results[self.i++]);
};

SearchContext.prototype.on_search_fail = function(self, xhr, textStatus, errorThrown) {
  console.log(textStatus, errorThrown);
  timeout(requestdelay).done(self.search);
};

function start() {
  var q = $('#q').val(),
      lang = $('#lang').val(),
      ctx;
  $('#running').show();
  currentsearch = ctx = new SearchContext(q, lang);
  ctx.next().done(function callback(result) {
    $('#tweettable').prepend(
      $('#tmpl-tweet-row').tmpl({result: result}));
    var text = textfilter(result.text, lang);
    detect(text).then(function(lang) {
      if ($.inArray(lang, speak_languages) === -1) {
        lang = speak_default_language;
      }
      speak(text, lang).then(
        function() { ctx.next().done(callback); },
        function() { ctx.next().done(callback); });
    }, function(xhr, textStatus, errorThrown) {
      console.log(textStatus, errorThrown);
      ctx.next().done(callback);
    });
  });
}

function stop() {
  currentsearch = null;
  $('#running').hide();
  if ($.browser.msie) {
    $('#iesound').get(0).pause();
  } else {
    $('#speakaudio').get(0).pause();
  }
}

function running_animation(i) {
  var j, s = '';
  for (j = 0; j < i; ++j) { s = s + '.'; }
  $('#running').html(s);
  timeout(1000).done(function() { running_animation((i + 1) % 5); });
}

function is_audio_type_supported(type) {
  var audio = null;
  try {
    audio = new Audio();
  } catch (e) {
    return false;
  }
  if (audio.canPlayType(type) === '') {
    return false;
  }
  return true;
}

jQuery(function($) {
  if (is_audio_type_supported('audio/wav')) {
    $('#notsupported').hide();
  } else {
    $('#notsupported').show();
  }
  getLanguagesForSpeak().done(function(languages) {
    speak_languages = languages;
  });
  $('#running').hide();
  running_animation(0);
});

</script>

</head>
<body>

<div>
<form onsubmit="return false;">
<input id="q" type="text" placeholder="twitter search" />
<select id="lang">
<option value="all">Any Language</option>
<option value="ar">Arabic (العربية)</option>
<option value="da">Danish (dansk)</option>
<option value="nl">Dutch (Nederlands)</option>
<option value="en">English</option>
<option value="fa">Farsi / Persian (فارسی)</option>
<option value="fi">Finnish (suomen kieli)</option>
<option value="fr">French (français)</option>
<option value="de">German (Deutsch)</option>
<option value="hu">Hungarian (Magyar)</option>
<option value="is">Icelandic (Íslenska)</option>
<option value="it">Italian (Italiano)</option>
<option value="ja">Japanese (日本語)</option>
<option value="no">Norwegian (Norsk)</option>
<option value="pl">Polish (polski)</option>
<option value="pt">Portuguese (Português)</option>
<option value="ru">Russian (русский язык)</option>
<option value="es">Spanish (español)</option>
<option value="sv">Swedish (Svenska)</option>
<option value="th">Thai (ไทย)</option>
</select>
<button type="submit" onclick="start();">start</button>
<button type="button" onclick="stop();">stop</button>
<audio id="speakaudio" controls="controls">audio tag is not supported.</audio>
<span id="notsupported">audio/wav is not supported.</span>
<span id="status"></span>
<span id="running"></span>
</form>
</div>
<!--[if IE]>
<div>
use media player for alternative.
<object id="iesound"
  classid="CLSID:22D6F312-B0F6-11D0-94AB-0080C74C7E95" height="50" width="200">
 <param name="AutoStart" value="true">
 <param name="ShowControls" value="true">
</object>
<script for="iesound" event="EndOfStream(lResult)" type="text/javascript">
document.getElementById('iesound').onended();
</script>
</div>
<![endif]-->


<table id="tweettable" style="width:100%">
</table>

<script id="tmpl-tweet-row" type="text/x-jquery-tmpl">
<tr>
  <td>
    <div class="avatar"><a href="http://twitter.com/${result.from_user}"><img src="${result.profile_image_url}" /></a></div>
  </td>
  <td width="100%">
    <div class="msg"><a href="http://twitter.com/${result.from_user}">${result.from_user}</a> {{html htmlfilter(result.text)}}</div>
  </td>
</tr>
</script>

</body>
</html>
