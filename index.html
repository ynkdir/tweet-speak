<!doctype html>
<!-- twitter search api + bing speak api -->
<html>
<head>
<meta charset="utf-8" />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="https://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>

<style>
td, th {
  vertical-align: top;
}

.avatar img {
  width: 48px;
  height: 48px;
}
</style>

<script>

// XXX: Change this variable to your appid.
// See http://www.bing.com/developers/
var bing_appid = '7E4F352C80692687D39E6CD42998104C5F79281C';

var speak_default_language = 'en';
var speak_languages = ['en'];

var rowdelay = 3000;
var requestdelay = 15000;

var searchid = 0;

function timeout(msec) {
  var d = $.Deferred();
  setTimeout(function(){ d.resolve(); }, msec);
  return d.promise();
}

function start() {
  var curid = ++searchid;
  $('#running').show();

  var loop = function(query) {
    var url = 'https://search.twitter.com/search.json';
    $.getJSON(url + query + '&callback=?')
      .done(function(data){
        if (curid != searchid) {
          return;
        }
        var results = data.results.reverse();
        if (results.length == 0) {
          $('#waiting').show();
          timeout(requestdelay).done(function(){loop(data.refresh_url);});
        } else {
          $('#waiting').hide();
          var f = function(i) {
            if (curid != searchid) {
              return;
            }
            if (i < results.length) {
              $('#tweettable').prepend(
                $('#tmpl-tweet-row').tmpl({result:results[i]}));
              var text = textfilter(results[i].text, lang);
              detect(text).done(function(lang) {
                if ($.inArray(lang, speak_languages) == -1) {
                  lang = speak_default_language;
                }
                speak(text, lang)
                  .then(function(){f(i + 1);},
                        function(){f(i + 1);});
              });
              //timeout(rowdelay).done(function(){f(i + 1);});
            } else {
              loop(data.refresh_url);
            }
          };
          f(0);
        }
      });
  };

  var lang = $('#lang').val();
  var data = {
    q: $('#q').val(),
    result_type: 'recent',
    lang: lang
  };
  loop('?' + $.param(data));
}

function stop() {
  ++searchid;
  $('#running').hide();
  $('#waiting').hide();
  $('#speakaudio').get(0).pause();
}

function speak(text, lang) {
  var d = $.Deferred();
  var url = 'https://api.microsofttranslator.com/V2/Ajax.svc/Speak';
  var data = {
    appId: bing_appid,
    text: text,
    language: lang
  };
  $.ajax({
    url: url,
    data: data,
    dataType: 'json',
    jsonp: 'oncomplete'
  }).then(function(streamurl) {
    $('#speakaudio')
      .attr('src', streamurl)
      .bind('ended', function() { d.resolve(); })
      .get(0).play();
  }, function() {
    d.reject();
  });
  return d.promise();
}

function detect(text) {
  var url = 'https://api.microsofttranslator.com/V2/Ajax.svc/Detect';
  var data = {
    appId: bing_appid,
    text: text
  };
  return $.ajax({
      url: url,
      data: data,
      dataType: 'json',
      jsonp: 'oncomplete'
    });
}

function getLanguagesForSpeak() {
  var url = 'http://api.microsofttranslator.com/V2/Ajax.svc/GetLanguagesForSpeak';
  var data = {
    appId: bing_appid
  };
  return $.ajax({
      url: url,
      data: data,
      dataType: 'json',
      jsonp: 'oncomplete'
    });
}

// TODO:
function textfilter(text, lang) {
  var s = text.replace(/(?:https?|ftp):\/\/[\x00-\x08\x0A-\x1F\x21-\x7F]*/g, '');
  return s;
}

function running_animation(i) {
  if (i >= 5) { i = 0; }
  var s = '';
  for (var j = 0; j < i; ++j) { s = s + '.'; }
  $('#running').html(s);
  timeout(1000).done(function(){running_animation(i + 1);});
}

jQuery(function($){
  getLanguagesForSpeak().done(function(languages) {
    speak_languages = languages;
  });
  $('#waiting').hide();
  $('#running').hide();
  running_animation(0);
});

</script>

</head>
<body>

<div>
firefox4, opera11<br />
twitter search: <input id="q" type="text" />
<select id="lang">
<option value="all">Any Language</option>
<option value="ar">Arabic (العربية)</option>
<option value="da">Danish (dansk)</option>
<option value="nl">Dutch (Nederlands)</option>
<option value="en">English</option>
<option value="fa">Farsi / Persian (فارسی)</option>
<option value="fi">Finnish (suomen kieli)</option>
<option value="fr">French (français)</option>
<option value="de">German (Deutsch)</option>
<option value="hu">Hungarian (Magyar)</option>
<option value="is">Icelandic (Íslenska)</option>
<option value="it">Italian (Italiano)</option>
<option value="ja">Japanese (日本語)</option>
<option value="no">Norwegian (Norsk)</option>
<option value="pl">Polish (polski)</option>
<option value="pt">Portuguese (Português)</option>
<option value="ru">Russian (русский язык)</option>
<option value="es">Spanish (español)</option>
<option value="sv">Swedish (Svenska)</option>
<option value="th">Thai (ไทย)</option>
</select>
<button type="button" onclick="start()">start</button>
<button type="button" onclick="stop()">stop</button>
<audio id="speakaudio" controls="controls"></audio>
<span id="waiting">waiting</span>
<span id="running"></span>
</div>

<table id="tweettable" style="width:100%">
</table>

<script id="tmpl-tweet-row" type="text/x-jquery-tmpl">
<tr>
  <td>
    <div class="avatar"><a href="http://twitter.com/${result.from_user}"><img src="${result.profile_image_url}" /></a></div>
  </td>
  <td width="100%">
    <div class="msg"><a href="http://twitter.com/${result.from_user}">${result.from_user}</a> ${result.text}</div>
  </td>
</tr>
</script>

</body>
</html>
