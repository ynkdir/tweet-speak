<!doctype html>
<!-- twitter search api + bing speak api -->
<html>
<head>
<meta charset="utf-8" />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="https://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>

<style>
td, th {
  vertical-align: top;
}

.avatar img {
  width: 48px;
  height: 48px;
}
</style>

<script>

// XXX: Change this variable to your appid.
// See http://www.bing.com/developers/
var bing_appid = '7E4F352C80692687D39E6CD42998104C5F79281C';

var rowdelay = 3000;
var requestdelay = 15000;

var searchid = 0;

function timeout(msec) {
  var d = $.Deferred();
  setTimeout(function(){ d.resolve(); }, msec);
  return d.promise();
}

function start() {
  var curid = ++searchid;
  $('#running').show();

  var loop = function(query) {
    var url = 'https://search.twitter.com/search.json';
    $.getJSON(url + query + '&callback=?')
      .done(function(data){
        if (curid != searchid) {
          return;
        }
        var results = data.results.reverse();
        if (results.length == 0) {
          $('#waiting').show();
          timeout(requestdelay).done(function(){loop(data.refresh_url);});
        } else {
          $('#waiting').hide();
          var f = function(i) {
            if (curid != searchid) {
              return;
            }
            if (i < results.length) {
              $('#tweettable').prepend(
                $('#tmpl-tweet-row').tmpl({result:results[i]}));
              var text = textfilter(results[i].text, lang);
              detect(text).done(function(lang) {
                speak(text, lang).done(function(){f(i + 1);});
              });
              //timeout(rowdelay).done(function(){f(i + 1);});
            } else {
              loop(data.refresh_url);
            }
          };
          f(0);
        }
      });
  };

  var lang = $('#lang').val();
  var data = {
    q: $('#q').val(),
    result_type: 'recent',
    lang: lang
  };
  loop('?' + $.param(data));
}

function stop() {
  ++searchid;
  $('#running').hide();
  $('#waiting').hide();
  $('#speakaudio').get(0).pause();
}

function speak(text, lang) {
  var d = $.Deferred();
  var url = "https://api.microsofttranslator.com/v2/Http.svc/Speak";
  var data = {
    appId: bing_appid,
    text: text,
    language: lang
  };
  $('#speakaudio')
    .attr('src', url + '?' + $.param(data))
    .bind('ended', function() { d.resolve(); })
    .get(0).play();
  return d.promise();
}

function detect(text) {
  var url = 'https://api.microsofttranslator.com/V2/Ajax.svc/Detect';
  var data = {
    appId: bing_appid,
    text: text
  };
  return $.ajax({
      url: url,
      data: data,
      dataType: 'json',
      jsonp: 'oncomplete'
    });
}

// TODO:
function textfilter(text, lang) {
  var s = text.replace(/(?:https?|ftp):\/\/[\x00-\x08\x0A-\x1F\x21-\x7F]*/g, '');
  return s;
}

function running_animation(i) {
  if (i >= 5) { i = 0; }
  var s = '';
  for (var j = 0; j < i; ++j) { s = s + '.'; }
  $('#running').html(s);
  timeout(1000).done(function(){running_animation(i + 1);});
}

jQuery(function($){
  $('#waiting').hide();
  $('#running').hide();
  running_animation(0);
});

</script>

</head>
<body>

<div>
firefox4, opera11<br />
twitter search: <input id="q" type="text" />
<select id="lang">
<option value="all">all</option>
<option value="ar">ar</option>
<option value="da">da</option>
<option value="nl">nl</option>
<option value="en">en</option>
<option value="fa">fa</option>
<option value="fi">fi</option>
<option value="fr">fr</option>
<option value="de">ge</option>
<option value="hu">hu</option>
<option value="is">is</option>
<option value="it">it</option>
<option selected="selected" value="ja">ja</option>
<option value="no">no</option>
<option value="pl">pl</option>
<option value="pt">pt</option>
<option value="ru">ru</option>
<option value="es">es</option>
<option value="sv">sv</option>
<option value="th">th</option>
</select>
<button type="button" onclick="start()">start</button>
<button type="button" onclick="stop()">stop</button>
<span id="waiting">waiting</span>
<span id="running"></span>
</div>

<div style="position:relative; height:3em;">
<audio id="speakaudio" controls="controls" style="position:absolute;bottom:0;" />
</div>

<table id="tweettable" style="width:100%">
</table>

<script id="tmpl-tweet-row" type="text/x-jquery-tmpl">
<tr>
  <td>
    <div class="avatar"><a href="http://twitter.com/${result.from_user}"><img src="${result.profile_image_url}" /></a></div>
  </td>
  <td width="100%">
    <div class="msg"><a href="http://twitter.com/${result.from_user}">${result.from_user}</a> ${result.text}</div>
  </td>
</tr>
</script>

</body>
</html>
