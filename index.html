<!doctype html>
<!-- twitter search api + bing speak api -->
<html>
<head>
<meta charset="utf-8" />

<title>tweet-speak</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script>
<script src="https://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>

<style>
td, th {
  vertical-align: top;
}

.avatar img {
  width: 48px;
  height: 48px;
}
</style>

<script>

// XXX: Change this variable to your appid.
// See http://www.bing.com/developers/
var bing_appid = '7E4F352C80692687D39E6CD42998104C5F79281C';

var speak_default_language = 'en';
var speak_languages = ['en'];

var rowdelay = 3000;
var requestdelay = 15000;

var searchid = 0;

function timeout(msec) {
  var d = $.Deferred();
  setTimeout(function() { d.resolve(); }, msec);
  return d.promise();
}

function search(q, lang, since_id) {
  var url = 'https://search.twitter.com/search.json';
  var data = {
    q: q,
    lang: lang,
    result_type: 'recent'
  };
  if (since_id) {
    data.since_id = since_id;
  }
  return $.ajax({
    url: url,
    data: data,
    dataType: 'jsonp',
    jsonp: 'callback'
  });
}

function start() {
  var curid = ++searchid;
  $('#running').show();

  var q = $('#q').val();
  var lang = $('#lang').val();

  function each(data, i) {
    if (curid !== searchid) {
      return;
    }
    if (i >= data.results.length) {
      next(data.max_id_str);
      return;
    }
    var result = data.results[data.results.length - i - 1];
    $('#tweettable').prepend(
      $('#tmpl-tweet-row').tmpl({result: result}));
    var text = textfilter(result.text, lang);
    detect(text).then(function(lang) {
      if ($.inArray(lang, speak_languages) === -1) {
        lang = speak_default_language;
      }
      speak(text, lang)
        .then(function() { each(data, i + 1); },
              function() { each(data, i + 1); });
    }, function(xhr, textStatus, errorThrown) {
      console.log(textStatus, errorThrown);
      each(data, i + 1);
    });
  }

  function next(since_id) {
    search(q, lang, since_id).done(function(data) {
      // MEMO: data.refresh_url doesn't contain lang param
      if (curid !== searchid) {
        return;
      }
      if (data.results === undefined) {
        stop();
        return;
      }
      if (data.results.length === 0) {
        $('#waiting').show();
        timeout(requestdelay).done(function() { next(data.max_id_str); });
      } else {
        $('#waiting').hide();
        each(data, 0);
      }
    });
  }

  next(null);
}

function stop() {
  ++searchid;
  $('#running').hide();
  $('#waiting').hide();
  if ($.browser.msie) {
    $('#iesound').get(0).pause();
  } else {
    $('#speakaudio').get(0).pause();
  }
}

function speak(text, lang) {
  var d = $.Deferred();
  var url = 'https://api.microsofttranslator.com/V2/Ajax.svc/Speak';
  var data = {
    appId: bing_appid,
    text: text,
    language: lang
  };
  $.ajax({
    url: url,
    data: data,
    dataType: 'jsonp',
    jsonp: 'oncomplete'
  }).then(function(streamurl) {
    if ($.browser.msie) {
      var iesound = $('#iesound').get(0);
      iesound.onended = function() { d.resolve(); };
      iesound.FileName = streamurl;
    } else {
      $('#speakaudio')
        .attr('src', streamurl)
        .bind('ended', function() { d.resolve(); })
        .get(0).play();
    }
  }, function(xhr, textStatus, errorThrown) {
    console.log(textStatus, errorThrown);
    d.reject();
  });
  return d.promise();
}

function detect(text) {
  var url = 'https://api.microsofttranslator.com/V2/Ajax.svc/Detect';
  var data = {
    appId: bing_appid,
    text: text
  };
  return $.ajax({
      url: url,
      data: data,
      dataType: 'jsonp',
      jsonp: 'oncomplete'
    });
}

function getLanguagesForSpeak() {
  var url = 'http://api.microsofttranslator.com/V2/Ajax.svc/GetLanguagesForSpeak';
  var data = {
    appId: bing_appid
  };
  return $.ajax({
      url: url,
      data: data,
      dataType: 'jsonp',
      jsonp: 'oncomplete'
    });
}

// TODO:
function textfilter(text, lang) {
  var s = text;
  // decode html entity
  s = $('<div\/>').html(s).text();
  s = s.replace(/[a-z]+:\/\/[\x00-\x08\x0A-\x1F\x21-\x7F]+/g, '');
  // WORKAROUND: bing ajax api returns error for text=%22
  // "There was an error deserializing the object of type System.String. Unexpected end of file. Following elements are not closed: root."
  s = s.replace(/"/g, ' ');
  return s;
}

function htmlfilter(text) {
  var s = text;
  s = s.replace(/[a-z]+:\/\/[\x00-\x08\x0A-\x1F\x21-\x7F]+/g, '<a href="$&">$&<\/a>');
  return s;
}

function running_animation(i) {
  var j, s = '';
  for (j = 0; j < i; ++j) { s = s + '.'; }
  $('#running').html(s);
  timeout(1000).done(function() { running_animation((i + 1) % 5); });
}

function is_audio_type_supported(type) {
  var audio = null;
  try {
    audio = new Audio();
  } catch (e) {
    return false;
  }
  if (audio.canPlayType(type) === '') {
    return false;
  }
  return true;
}

jQuery(function($) {
  if (is_audio_type_supported('audio/wav')) {
    $('#notsupported').hide();
  } else {
    $('#notsupported').show();
  }
  getLanguagesForSpeak().done(function(languages) {
    speak_languages = languages;
  });
  $('#waiting').hide();
  $('#running').hide();
  running_animation(0);
});

</script>

</head>
<body>

<div>
<form onsubmit="return false;">
<input id="q" type="text" placeholder="twitter search" />
<select id="lang">
<option value="all">Any Language</option>
<option value="ar">Arabic (العربية)</option>
<option value="da">Danish (dansk)</option>
<option value="nl">Dutch (Nederlands)</option>
<option value="en">English</option>
<option value="fa">Farsi / Persian (فارسی)</option>
<option value="fi">Finnish (suomen kieli)</option>
<option value="fr">French (français)</option>
<option value="de">German (Deutsch)</option>
<option value="hu">Hungarian (Magyar)</option>
<option value="is">Icelandic (Íslenska)</option>
<option value="it">Italian (Italiano)</option>
<option value="ja">Japanese (日本語)</option>
<option value="no">Norwegian (Norsk)</option>
<option value="pl">Polish (polski)</option>
<option value="pt">Portuguese (Português)</option>
<option value="ru">Russian (русский язык)</option>
<option value="es">Spanish (español)</option>
<option value="sv">Swedish (Svenska)</option>
<option value="th">Thai (ไทย)</option>
</select>
<button type="submit" onclick="start();">start</button>
<button type="button" onclick="stop();">stop</button>
<audio id="speakaudio" controls="controls">audio tag is not supported.</audio>
<span id="notsupported">audio/wav is not supported.</span>
<span id="waiting">waiting</span>
<span id="running"></span>
</form>
</div>
<!--[if IE]>
<div>
use media player for alternative.
<object id="iesound"
  classid="CLSID:22D6F312-B0F6-11D0-94AB-0080C74C7E95" height="50" width="200">
 <param name="AutoStart" value="true">
 <param name="ShowControls" value="true">
</object>
<script for="iesound" event="EndOfStream(lResult)" type="text/javascript">
document.getElementById('iesound').onended();
</script>
</div>
<![endif]-->


<table id="tweettable" style="width:100%">
</table>

<script id="tmpl-tweet-row" type="text/x-jquery-tmpl">
<tr>
  <td>
    <div class="avatar"><a href="http://twitter.com/${result.from_user}"><img src="${result.profile_image_url}" /></a></div>
  </td>
  <td width="100%">
    <div class="msg"><a href="http://twitter.com/${result.from_user}">${result.from_user}</a> {{html htmlfilter(result.text)}}</div>
  </td>
</tr>
</script>

</body>
</html>

